<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="skin.css"/>
</head>
<body>
<script src="../lib/require.js"></script>
<script>
    require.config({
        paths:{
            backbone:"../lib/backbone",
            underscore:"../lib/underscore-min",
            jquery:"../lib/jquery-1.8.3.min",
            domReady:"../lib/domReady",
            tpl:"../lib/tpl"
        },
        shim:{
            backbone:{
                deps:["underscore", "jquery"],
                exports:"Backbone"
            },
            underscore:{
                exports:"_"
            }
        }
    });

    require(["jquery", "underscore", "backbone", "../src/validation", "../src/basicTests", "domReady!", "tpl!registrationForm.tpl"], function ($, _, Backbone, validation, basics, domReady, formTemplate) {
        validation.Validator.customize(basics);

        var RegistrationModel = validation.Model.extend({
            schema:{
                email:{
                    required:true,
                    type:String,
                    match:"email",
                    max:127,
                    registered:1000
                },
                password:{
                    required:true,
                    type:String,
                    range:{
                        min:5,
                        max:14
                    }
                },
                password2:{
                    duplicate:"password"
                }
            },
            validator:{
                tests:{
                    registered:function (done) {
                        var registeredEmails = {
                            "test@test.com":true,
                            "test@test.hu":true
                        };
                        setTimeout(function () {
                            done(registeredEmails[this.value]);
                        }.bind(this), this.config);
                    }
                },
                checks:{
                    registered:function (delay, key) {
                        return delay || 1;
                    }
                }
            }
        });

        var InputErrors = validation.Messenger.extend({
            messages:{
                email:{
                    required:"The email address is not given.",
                    type:"Email address must be string.",
                    match:"Not an email address.",
                    max:"The given email address is too long.",
                    registered:"The email address is already registered."
                },
                password:{
                    required:"The password is not given.",
                    type:"The password must be string.",
                    range:{
                        min:"The password is too short.",
                        max:"The password is too long."
                    }
                },
                password2:{
                    duplicate:"The verifier password does not equal to the password."
                }
            },
            display:function (attribute, chunks, pending) {
                var $input = this.options.$inputs[attribute];
                var message = "";
                if (chunks)
                    message += chunks.join("<br/>");
                if (pending)
                    message += "Pending ...";
                $input.next().html(message);
            }
        });

        var SubmitButtonDisabler = validation.Aggregator.extend({
            display:function (errors, pending) {
                if (errors + pending)
                    this.options.$button.attr("disabled", "disabled");
                else
                    this.options.$button.removeAttr("disabled");
            }
        });

        var RegistrationForm = Backbone.View.extend({
            tagName:"form",
            className:"registrationForm",
            template:formTemplate,
            initialize:function () {
                this.render();
            },
            render:function () {
                this.$el.html(this.template(this.model.toJSON()));
                this.bindInputs();
                this.bindButton();
                return this;
            },
            bindInputs:function () {
                this.$inputs = {};
                $("input", this.$el).each(function (index, input) {
                    var $input = $(input);
                    var attribute = $input.attr("name");
                    if (!attribute)
                        return;
                    $input.change(function () {
                        this.model.set(attribute, $input.val());
                    }.bind(this));
                    $input.next().css({color:"red"});
                    this.$inputs[attribute] = $input;
                }.bind(this));
                this.messenger = new InputErrors({
                    model:this.model.validator,
                    $inputs:this.$inputs
                });
            },
            bindButton:function () {
                this.$button = $("button", this.$el);
                this.aggregator = new SubmitButtonDisabler({
                    model:this.model.validator,
                    $button:this.$button
                });
            }
        });

        $("body").append(new RegistrationForm({
            model:new RegistrationModel({
                email:"test@test.hu",
                password:"password",
                password2:"password"
            })
        }).$el);

        $("body").append(new RegistrationForm({
            model:new RegistrationModel({
                email:"test@test.it",
                password:"password",
                password2:"password"
            })
        }).$el);
    });
</script>
</body>
</html>